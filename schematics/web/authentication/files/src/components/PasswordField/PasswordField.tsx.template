import React, { useState } from "react";

import { Control, FieldValues, Path } from "react-hook-form";
import { useTheme } from "@mui/styles";
import { IconButton, InputAdornment, Theme, Tooltip } from "@mui/material";
import GenericInputField from "@components/GenericInputField";
import { Lock, Visibility, VisibilityOff } from "@mui/icons-material";

interface Props<T extends FieldValues> {
  id?: string;
  name: Path<T>;
  control: Control<T>;
  error: string | undefined;
  label: string;
  dataTestId?: string;
  adornmentDataTestId?: string;
  placeholder?: string;
  autoFocus?: boolean;
  autoComplete?: string;
  withIcon?: boolean;
  labelWidth?: number;
}

const PasswordField = <T extends FieldValues>({
  id,
  name,
  error,
  label,
  control,
  dataTestId = "password-input-field",
  adornmentDataTestId = "show-password-button",
  placeholder,
  autoComplete,
  autoFocus,
  withIcon = true,
}: Props<T>): JSX.Element => {
  const theme = useTheme<Theme>();
  const [showPassword, setShowPassword] = useState<boolean>(false);

  const handleClickShowPassword = () => {
    setShowPassword((prevState) => !prevState);
  };

  const handleMouseDownPassword = (
    event: React.MouseEvent<HTMLButtonElement>
  ) => {
    event.preventDefault();
  };

  const visibilityButtonLabel = (passwordShown: boolean): string =>
    passwordShown ? "Hide password" : "Show password";

  return (
    <GenericInputField
      name={name}
      control={control}
      error={!!error}
      helperText={error}
      label={label}
      dataTestId={dataTestId}
      placeHolder={placeholder}
      type={showPassword ? "text" : "password"}
      InputProps={{
        endAdornment: withIcon && (
          <InputAdornment position="end">
            <Tooltip title={visibilityButtonLabel(showPassword)}>
              <IconButton
                aria-controls={id}
                data-testid={adornmentDataTestId}
                aria-expanded={showPassword}
                aria-label={visibilityButtonLabel(showPassword)}
                onClick={handleClickShowPassword}
                onMouseDown={handleMouseDownPassword}
                edge="end"
              >
                {showPassword ? (
                  <VisibilityOff htmlColor={theme.palette.secondary.dark} />
                ) : (
                  <Visibility htmlColor={theme.palette.secondary.light} />
                )}
              </IconButton>
            </Tooltip>
          </InputAdornment>
        ),
        startAdornment: (
          <InputAdornment position="start">
            <Lock color="secondary" />
          </InputAdornment>
        ),
      }}
      autoFocus={autoFocus}
      autoComplete={autoComplete}
    />
  );
};

export default PasswordField;
